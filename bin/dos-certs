#!/usr/bin/env node

var path = require('path');
var resolve = path.resolve;

// Little hack to include `NODE_PATH=.`
require('node-path')(module, [resolve('.')]);

var fs = require('fs');
var exists = fs.existsSync;
var exec = require('child_process').exec;
var config = require('lib/config');
var ssl = config('ssl');

if (!exists(ssl.serverCert) || !exists(ssl.serverKey)) {
  exec('openssl genrsa 1024 > server.key', function(err, stdout, stderr) {
    if (stdout.length) console.log(stdout);
    if (err != null) return console.log('Exception: ' + err), process.exit(1);

    exec('openssl req -new -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com" -key server.key -out csr.pem', function(err, stdout, stderr) {
      if (stdout.length) console.log(stdout);
      if (err != null) return console.log(err), process.exit(1);

      exec('openssl x509 -req -days 365 -in csr.pem -signkey server.key -out server.crt', function(err, stdout, stderr) {
        if (stdout.length) console.log(stdout);
        if (err != null) return console.log(err), process.exit(1);
        process.exit(0);
      });
    });
  });
}